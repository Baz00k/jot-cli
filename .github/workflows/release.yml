name: Release

on:
    workflow_run:
        workflows: ["CI"]
        branches: [master]
        types: [completed]

permissions:
    contents: write
    pull-requests: write

jobs:
    release-please:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        steps:
            - uses: googleapis/release-please-action@v4
              id: release
              with:
                  release-type: node

            # The following steps only run if a new release was created
            - name: Checkout
              if: "${{ steps.release.outputs.release_created }}"
              uses: actions/checkout@v5

            - name: Setup Bun
              if: "${{ steps.release.outputs.release_created }}"
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              if: "${{ steps.release.outputs.release_created }}"
              run: bun install

            - name: Build binaries
              if: "${{ steps.release.outputs.release_created }}"
              run: bun run compile:release

            - name: Generate checksums
              if: "${{ steps.release.outputs.release_created }}"
              run: shasum -a 256 bin/jot-* > bin/jot-checksums.txt

            - name: Prepare distributable manifests
              if: "${{ steps.release.outputs.release_created }}"
              run: |
                  mkdir -p dist
                  bun packaging/scripts/update-homebrew-formula.ts ${{ steps.release.outputs.tag_name }} bin/jot-checksums.txt
                  bun packaging/scripts/update-scoop-manifest.ts ${{ steps.release.outputs.tag_name }} bin/jot-checksums.txt

            - name: Upload Release Artifacts
              if: "${{ steps.release.outputs.release_created }}"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  gh release upload ${{ steps.release.outputs.tag_name }} \
                    bin/jot-linux-x64 \
                    bin/jot-linux-arm64 \
                    bin/jot-windows-x64.exe \
                    bin/jot-macos-arm64 \
                    bin/jot-macos-x64 \
                    bin/jot-checksums.txt \
                    scripts/install.sh \
                    scripts/install.ps1 \
                    dist/jot-cli.rb \
                    dist/jot.json
